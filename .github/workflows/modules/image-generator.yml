name: Image Generator Module

on:
  workflow_call:

jobs:
  generate-image:
    runs-on: ubuntu-latest
    
    outputs:
      image-url: ${{ steps.generate.outputs.image-url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Generate Morning Image
      id: generate
      env:
        QWEN_IMAGE: ${{ secrets.QWEN_IMAGE }}
      run: |
        # ç”»åƒç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        cat > image_prompt.json << 'EOF'
        {
          "prompt": "Beautiful morning scene with sunrise, peaceful and warm atmosphere, soft lighting, nature landscape, calming colors",
          "image_size": "square",
          "num_inference_steps": 28,
          "guidance_scale": 7.5
        }
        EOF
        
        # Kamui Code MCPç”»åƒç”ŸæˆAPIï¼ˆ3å›ãƒªãƒˆãƒ©ã‚¤ï¼‰
        max_retries=3
        retry_count=0
        success=false
        
        while [ $retry_count -lt $max_retries ] && [ "$success" = "false" ]; do
          retry_count=$((retry_count + 1))
          echo "ğŸ”„ Attempt $retry_count/$max_retries: Generating image via Kamui Code MCP..."
          
          response=$(curl -s -w "HTTPSTATUS:%{http_code}" -X POST "$QWEN_IMAGE" \
            -H "Content-Type: application/json" \
            -d @image_prompt.json)
          
          # HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹æœ¬ä½“ã‚’åˆ†é›¢
          http_code=$(echo "$response" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
          response_body=$(echo "$response" | sed 's/HTTPSTATUS:[0-9]*$//')
          
          echo "HTTP Status: $http_code"
          
          # æˆåŠŸåˆ¤å®š
          if [ "$http_code" = "200" ]; then
            echo "âœ… Image generation successful"
            success=true
            break
          else
            echo "âŒ Attempt $retry_count failed with status $http_code"
            echo "Error details: $response_body"
            
            if [ $retry_count -lt $max_retries ]; then
              echo "â³ Waiting 5 seconds before retry..."
              sleep 5
            fi
          fi
        done
        
        # å…¨ã¦ã®ãƒªãƒˆãƒ©ã‚¤ãŒå¤±æ•—ã—ãŸå ´åˆ
        if [ "$success" = "false" ]; then
          echo "âŒ All $max_retries attempts failed. Image generation API is unavailable."
          echo "ğŸš« Stopping workflow execution."
          exit 1
        fi
        
        echo "Image API Response: $response_body"
        
        # ç”»åƒURLã‚’æŠ½å‡º
        image_url=$(echo "$response_body" | jq -r '.images[0].url // .image_url // .url // ""')
        
        # ç”»åƒURLå–å¾—ãƒã‚§ãƒƒã‚¯
        if [ -z "$image_url" ] || [ "$image_url" = "null" ]; then
          echo "âŒ Failed to extract image URL from API response"
          echo "ğŸš« Stopping workflow execution."
          exit 1
        fi
        
        echo "ğŸ–¼ï¸ Generated image URL: $image_url"
        
        # ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã¨ã—ã¦è¨­å®š
        echo "image-url=$image_url" >> $GITHUB_OUTPUT
        
        echo "âœ… Image generation completed"
        
    - name: Display Image Result
      run: |
        echo "ğŸ–¼ï¸ Generated image URL: ${{ steps.generate.outputs.image-url }}"