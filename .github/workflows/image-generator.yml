name: Image Generator Module

on:
  workflow_call:

jobs:
  generate-image:
    runs-on: ubuntu-latest
    
    outputs:
      image-url: ${{ steps.generate.outputs.image-url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Claude Code CLI
      run: |
        # Claude Code CLIをインストール
        curl -fsSL https://claude.ai/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        
    - name: Generate Morning Image
      id: generate
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      run: |
        # Claude Code CLIで認証
        echo "$CLAUDE_CODE_OAUTH_TOKEN" | claude auth login --token
        
        # Claude Code CLIで画像生成（3回リトライ）
        max_retries=3
        retry_count=0
        success=false
        
        while [ $retry_count -lt $max_retries ] && [ "$success" = "false" ]; do
          retry_count=$((retry_count + 1))
          echo "🔄 Attempt $retry_count/$max_retries: Generating image with Claude Code..."
          
          # Claude Code CLIでMCP経由画像生成
          image_url=$(claude --no-input "MCPのQwen画像生成を使って、美しい朝の風景画像を生成して。日の出、平和で暖かい雰囲気、柔らかい光、自然の風景、落ち着いた色合いで。画像のURLを返して。" 2>/dev/null | grep -oE 'https?://[^\s]+\.(jpg|jpeg|png|webp)' | head -1)
          
          # 成功チェック
          if [ $? -eq 0 ] && [ -n "$image_url" ]; then
            echo "✅ Image generation successful"
            success=true
            break
          else
            echo "❌ Attempt $retry_count failed"
            
            if [ $retry_count -lt $max_retries ]; then
              echo "⏳ Waiting 5 seconds before retry..."
              sleep 5
            fi
          fi
        done
        
        # 全てのリトライが失敗した場合
        if [ "$success" = "false" ]; then
          echo "❌ All $max_retries attempts failed. Claude Code image generation is unavailable."
          echo "🚫 Stopping workflow execution."
          exit 1
        fi
        
        echo "🖼️ Generated image URL: $image_url"
        
        # アウトプットとして設定
        echo "image-url=$image_url" >> $GITHUB_OUTPUT
        
        echo "✅ Image generation completed"
        
    - name: Display Image Result
      run: |
        echo "🖼️ Generated image URL: ${{ steps.generate.outputs.image-url }}"