name: Image Generator Module

on:
  workflow_call:

jobs:
  generate-image:
    runs-on: ubuntu-latest
    
    outputs:
      image-url: ${{ steps.generate.outputs.image-url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install Claude Code SDK
      run: npm install @anthropic-ai/claude-code
        
    - name: Generate Morning Image
      id: generate
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        QWEN_IMAGE: ${{ secrets.QWEN_IMAGE }}
      run: |
        # QWEN_IMAGE URLã®ç¢ºèª
        if [ -z "$QWEN_IMAGE" ]; then
          echo "::error::QWEN_IMAGE is not set in GitHub Secrets"
          exit 1
        fi
        echo "âœ… QWEN_IMAGE URL is configured"
        
        # MCPè¨­å®šã‚’ä½œæˆ
        echo '{
          "mcpServers": {
            "t2i-kamui-qwen-image": {
              "type": "http",
              "url": "'${QWEN_IMAGE}'",
              "description": "Qwen-Image Text-to-Image via Kamui Code"
            }
          }
        }' > mcp-config.json
        
        # ç”»åƒç”Ÿæˆãƒªãƒˆãƒ©ã‚¤ãƒ«ãƒ¼ãƒ—ï¼ˆæœ€å¤§3å›ï¼‰
        SUCCESS=false
        for RETRY_COUNT in {1..3}; do
          echo "ğŸ”„ ç”»åƒç”Ÿæˆè©¦è¡Œ $RETRY_COUNT/3"
          
          # scene.ymlãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
          SCENE_DATA=$(cat yml/scene.yml)
          echo "ğŸ“‹ scene.ymlãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ"
          
          # Claude Code SDKã§ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã€è¡¨æƒ…ã€ãƒãƒ¼ã‚ºã€ã‚«ãƒ¡ãƒ©ã‚’ç”Ÿæˆ
          PROMPT="yml/scene.ymlã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’ä½¿ã£ã¦ã€ã‚¢ãƒ‹ãƒ¡ã‚¹ã‚¿ã‚¤ãƒ«ã®é«˜å“è³ªãƒ‡ã‚¸ã‚¿ãƒ«ã‚¢ãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ã¾ãšReadãƒ„ãƒ¼ãƒ«ã§yml/scene.ymlãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã€ãã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’ç†è§£ã—ã¦ãã ã•ã„ã€‚ãã®ä¸Šã§ã€ä»¥ä¸‹ã®æ‰‹é †ã§å‰µæ„å·¥å¤«ã—ã¦ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š1.ã¾ãšé­…åŠ›çš„ãªã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå ´æ‰€ãƒ»æ™‚é–“ãƒ»ç’°å¢ƒãƒ»çŠ¶æ³ï¼‰ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºå®šã€2.ãã®ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã«æœ€ã‚‚é©ã—ãŸè¡¨æƒ…ã‚’é¸æŠï¼ˆä¾‹ï¼šæ•™å®¤ãªã‚‰é›†ä¸­ã€å…¬åœ’ãªã‚‰æ¥½ã—ãã†ã€å›³æ›¸é¤¨ãªã‚‰é™ã‹ã€ãŠç¥­ã‚Šãªã‚‰ã‚ãã‚ãï¼‰ã€3.ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã¨è¡¨æƒ…ã«åˆã†è‡ªç„¶ãªãƒãƒ¼ã‚ºã‚’é¸æŠï¼ˆä¾‹ï¼šæœ¬ã‚’èª­ã‚“ã§ã„ã‚‹ãªã‚‰åº§ã£ã¦æœ¬ã‚’æŒã¤ã€èµ°ã£ã¦ã„ã‚‹ãªã‚‰å‹•çš„ãªãƒãƒ¼ã‚ºï¼‰ã€4.ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ€ã‚‚é­…åŠ›çš„ã«è¦‹ã›ã‚‹ã‚«ãƒ¡ãƒ©ã‚¢ãƒ³ã‚°ãƒ«ã‚’é¸æŠï¼ˆä¾‹ï¼šã‚¸ãƒ£ãƒ³ãƒ—ãªã‚‰å°‘ã—ä¸‹ã‹ã‚‰ã€èª­æ›¸ãªã‚‰ã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒƒãƒ—ï¼‰ã€5.ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã«åˆã£ãŸè©³ç´°ãªèƒŒæ™¯ã‚’æç”»ï¼ˆä¾‹ï¼šæ•™å®¤ãªã‚‰é»’æ¿ãƒ»æœºãƒ»çª“ã€å…¬åœ’ãªã‚‰ç·‘ãƒ»ãƒ™ãƒ³ãƒãƒ»é’ç©ºã€å›³æ›¸é¤¨ãªã‚‰æœ¬æ£šãƒ»é™ã‹ãªé›°å›²æ°—ï¼‰ã€‚ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯scene.ymlã®è¨­å®šé€šã‚Šï¼ˆã‚¢ãƒ‹ãƒ¡å¥³å­é«˜ç”Ÿã®ãƒ„ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ«ã€ã‚»ãƒ¼ãƒ©ãƒ¼æœã€ä¸‰æ¯›çŒ«ã®ç›¸æ£’ï¼‰ã§ã€ã‚¢ãƒ‹ãƒ¡/ãƒãƒ³ã‚¬é¢¨ã®é«˜å“è³ªãƒ‡ã‚¸ã‚¿ãƒ«ã‚¢ãƒ¼ãƒˆã€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã¯æ­£æ–¹å½¢(square)ã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚**é‡è¦**: ç”Ÿæˆå®Œäº†å¾Œã€å¿…ãšç”»åƒã®URLã‚’æ˜ç¢ºã«è¡¨ç¤ºã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šhttps://example.com/image.pngï¼‰ã€‚"
          
          echo "ğŸ¤– Claude Code SDKå®Ÿè¡Œé–‹å§‹"
          
          # Claude Code SDKã®å®Ÿè¡Œ
          IMAGE_RESULT=$(timeout 180 npx @anthropic-ai/claude-code \
            --mcp-config="$(pwd)/mcp-config.json" \
            --allowedTools "Read,mcp__t2i-kamui-qwen-image" \
            --max-turns 8 \
            --permission-mode "acceptEdits" \
            --print \
            "$PROMPT" 2>&1) || {
                CLAUDE_EXIT_CODE=$?
                echo "::error::âŒ Claude Codeå®Ÿè¡Œå¤±æ•— (exit code: $CLAUDE_EXIT_CODE)"
                if [ $CLAUDE_EXIT_CODE -eq 124 ]; then
                  echo "::error::âŒ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ (3åˆ†)"
                fi
                IMAGE_RESULT=""
              }
          
          echo "ğŸ¨ ç”»åƒç”Ÿæˆçµæœ:"
          echo "$IMAGE_RESULT"
          
          # çµæœã‹ã‚‰URLã‚’æŠ½å‡ºï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
          IMAGE_URL=""
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³1: https://ã§å§‹ã¾ã‚‹ç”»åƒURL
          IMAGE_URL=$(echo "$IMAGE_RESULT" | grep -oP 'https://[^\s`"]+\.(png|jpg|jpeg|webp)' | head -1)
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³2: ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã‹ã‚‰ç”»åƒURLã‚’æ¨å®š
          if [ -z "$IMAGE_URL" ]; then
            REQUEST_ID=$(echo "$IMAGE_RESULT" | grep -oP 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆID\s*`?([a-f0-9-]+)`?' | sed 's/.*`\?\([a-f0-9-]\+\)`\?.*/\1/')
            if [ ! -z "$REQUEST_ID" ]; then
              echo "ğŸ” ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDæ¤œå‡º: $REQUEST_ID"
              # Kamui Code APIã‹ã‚‰çµæœã‚’å–å¾—ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ ã™ã‚‹å¯èƒ½æ€§
            fi
          fi
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³3: MCPå‡ºåŠ›ã‹ã‚‰ç›´æ¥URLå–å¾—ã‚’è©¦è¡Œ
          if [ -z "$IMAGE_URL" ]; then
            echo "ğŸ”„ MCPã‹ã‚‰ç›´æ¥ç”»åƒURLå–å¾—ã‚’è©¦è¡Œ..."
            MCP_RESULT=$(timeout 60 npx @anthropic-ai/claude-code \
              --mcp-config="$(pwd)/mcp-config.json" \
              --allowedTools "mcp__t2i-kamui-qwen-image" \
              --max-turns 3 \
              --permission-mode "acceptEdits" \
              --print \
              "å‰å›ã®ç”»åƒç”Ÿæˆçµæœã‹ã‚‰ç”»åƒURLã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDãŒã‚ã‚‹å ´åˆã¯çµæœç¢ºèªã—ã¦ãã ã•ã„ã€‚" 2>&1)
            
            IMAGE_URL=$(echo "$MCP_RESULT" | grep -oP 'https://[^\s`"]+\.(png|jpg|jpeg|webp)' | head -1)
          fi
          
          echo "ğŸ” URLæŠ½å‡ºçµæœ: '$IMAGE_URL'"
          
          # ç”»åƒURLå–å¾—ãƒã‚§ãƒƒã‚¯
          if [ ! -z "$IMAGE_URL" ] && [[ "$IMAGE_URL" =~ ^https:// ]]; then
            echo "âœ… ç”»åƒURLã‚’å–å¾—æˆåŠŸ: $IMAGE_URL"
            SUCCESS=true
            break
          fi
          
          echo "::warning::âš ï¸ ç”»åƒç”Ÿæˆå¤±æ•—ï¼ˆè©¦è¡Œ $RETRY_COUNT/3ï¼‰"
          
          if [ $RETRY_COUNT -lt 3 ]; then
            echo "ğŸ”„ 5ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™..."
            sleep 5
          fi
        done
        
        # æœ€çµ‚çµæœãƒã‚§ãƒƒã‚¯
        if [ "$SUCCESS" != "true" ]; then
          echo "::error::âŒ ç”»åƒç”Ÿæˆã«3å›å¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
        fi
        
        echo "âœ… ç”»åƒURLå–å¾—å®Œäº†: $IMAGE_URL"
        
        # ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã¨ã—ã¦è¨­å®š
        echo "image-url=$IMAGE_URL" >> $GITHUB_OUTPUT
        
        echo "âœ… Image generation completed"
        
    - name: Display Image Result
      run: |
        echo "ğŸ–¼ï¸ Generated image: ${{ steps.generate.outputs.image-url }}"