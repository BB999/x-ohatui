name: Image Generator Module

on:
  workflow_call:
    outputs:
      image-url:
        value: ${{ jobs.generate-image.outputs.url }}
      image-file:
        value: ${{ jobs.generate-image.outputs.file }}

jobs:
  generate-image:
    runs-on: ubuntu-latest
    
    outputs:
      url: ${{ steps.generate.outputs.image-url }}
      file: ${{ steps.generate.outputs.image-file }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Download Text Artifacts
      uses: actions/download-artifact@v4
      with:
        name: morning-content
        path: ./content
        
    - name: Read Generated Content
      id: read-content
      run: |
        echo "ğŸ“– Reading generated content..."
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        ls -la ./content/
        
        # ã‚³ãƒ³ãƒ†ãƒ³ãƒ„èª­ã¿è¾¼ã¿
        if [ -f "./content/scene-description.txt" ]; then
          SCENE=$(cat "./content/scene-description.txt")
          echo "scene=$SCENE" >> $GITHUB_OUTPUT
          echo "ğŸ¬ Scene: $SCENE"
        else
          echo "::error::scene-description.txt not found"
          exit 1
        fi
        
        if [ -f "./content/mamehina-dialogue.txt" ]; then
          MAMEHINA=$(cat "./content/mamehina-dialogue.txt")
          echo "mamehina=$MAMEHINA" >> $GITHUB_OUTPUT
          echo "ğŸ‘§ ã¾ã‚ã²ãªãŸ: $MAMEHINA"
        fi
        
        if [ -f "./content/kipferl-dialogue.txt" ]; then
          KIPFERL=$(cat "./content/kipferl-dialogue.txt")
          echo "kipferl=$KIPFERL" >> $GITHUB_OUTPUT
          echo "ğŸ± ã‚­ãƒ—ãƒ•ã‚§ãƒ«: $KIPFERL"
        fi
        
    - name: Install Claude Code SDK
      run: |
        echo "ğŸ“¦ Claude Code SDKã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        npm install @anthropic-ai/claude-code --force 2>/dev/null || echo "âš ï¸ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ã—ã¦ç¶šè¡Œ"
        
    - name: Generate Morning Image
      id: generate
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        NANO_BANANA_EDIT: ${{ secrets.NANO_BANANA_EDIT }}
      run: |
        # NANO_BANANA_EDIT URLã®ç¢ºèª
        if [ -z "$NANO_BANANA_EDIT" ]; then
          echo "::error::NANO_BANANA_EDIT is not set in GitHub Secrets"
          exit 1
        fi
        echo "âœ… NANO_BANANA_EDIT URL is configured"
        
        # MCPè¨­å®šã‚’ä½œæˆ
        echo '{
          "mcpServers": {
            "nano-banana-edit-kamui": {
              "type": "http", 
              "url": "'${NANO_BANANA_EDIT}'",
              "description": "NANO_BANANA_EDIT Image Generation via Kamui Code"
            }
          }
        }' > mcp-config.json
        
        # ç”Ÿæˆã•ã‚ŒãŸã‚·ãƒ¼ãƒ³ã®å†…å®¹ã‚’å–å¾—
        SCENE_DESCRIPTION="${{ steps.read-content.outputs.scene }}"
        MAMEHINA_DIALOGUE="${{ steps.read-content.outputs.mamehina }}"
        KIPFERL_DIALOGUE="${{ steps.read-content.outputs.kipferl }}"
        echo "ğŸ“ Using generated scene: $SCENE_DESCRIPTION"
        echo "ğŸ‘§ ã¾ã‚ã²ãªãŸ: $MAMEHINA_DIALOGUE" 
        echo "ğŸ± ã‚­ãƒ—ãƒ•ã‚§ãƒ«: $KIPFERL_DIALOGUE"
        
        # ç”»åƒç”Ÿæˆãƒªãƒˆãƒ©ã‚¤ãƒ«ãƒ¼ãƒ—ï¼ˆæœ€å¤§3å›ï¼‰
        SUCCESS=false
        for RETRY_COUNT in {1..3}; do
          echo "ğŸ”„ ç”»åƒç”Ÿæˆè©¦è¡Œ $RETRY_COUNT/3"
          
          # å‚ç…§ç”»åƒã®URLï¼ˆã¾ã‚ã²ãªãŸã¨ã‚­ãƒ—ãƒ•ã‚§ãƒ«ï¼‰
          REF_IMAGE_1="file:///Users/noranekob/cursor/x-ohatui/images/MAMEHINATA.jpg"
          REF_IMAGE_2="file:///Users/noranekob/cursor/x-ohatui/images/kpfel.jpg"
          
          # ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆNANO_BANANA_EDITç”¨ï¼‰
          FULL_PROMPT="NANO_BANANA_EDITãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚å‚ç…§ç”»åƒ1: $REF_IMAGE_1 å‚ç…§ç”»åƒ2: $REF_IMAGE_2 ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³: $SCENE_DESCRIPTION ã¾ã‚ã²ãªãŸã®å°è©: $MAMEHINA_DIALOGUE ã‚­ãƒ—ãƒ•ã‚§ãƒ«ã®å°è©: $KIPFERL_DIALOGUE è©³ç´°æŒ‡ç¤º: å°è©ã®æ„Ÿæƒ…ã«åŸºã¥ã„ã¦è¡¨æƒ…ã¨ãƒãƒ¼ã‚ºã‚’æ±ºå®šã—ã€æœã®æ™‚é–“å¸¯ã«é©ã—ãŸèƒŒæ™¯ï¼ˆæ•™å®¤ãƒ»å®¶ãƒ»è¡—è§’ãƒ»å…¬åœ’ãªã©ï¼‰ã§2ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ç›¸äº’ä½œç”¨ãŒè¦‹ãˆã‚‹æ§‹å›³ã«ã—ã¦ãã ã•ã„ã€‚æœã®å…‰ãŒå·®ã—è¾¼ã‚€æ˜ã‚‹ã„é›°å›²æ°—ã§ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³è±Šã‹ã«ã€‚ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”1:1ã€‚morning-image.pngã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚"
          
          echo "ğŸ¤– Claude Code SDKå®Ÿè¡Œé–‹å§‹"
          
          # Claude Code SDKã®å®Ÿè¡Œï¼ˆRADIO-workflowã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
          echo "ğŸš€ Starting Morning Image Generation..."
          echo "ğŸ“ Prompt length: ${#FULL_PROMPT}"
          echo "ğŸ“‹ Environment Check:"
          echo "Working directory: $(pwd)"
          echo "NANO_BANANA_EDIT URL configured: Yes"
          
          echo "ğŸ¯ Claude Code SDKå®Ÿè¡Œä¸­ï¼ˆ180ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰..."
          IMAGE_RESULT=$(timeout 180 npx @anthropic-ai/claude-code \
            --mcp-config="$(pwd)/mcp-config.json" \
            --allowedTools "Read,mcp__nano-banana-edit-kamui__nano_banana_edit" \
            --max-turns 12 \
            --permission-mode "bypassPermissions" \
            --print \
            --verbose \
            "$FULL_PROMPT" 2>&1) || {
                CLAUDE_EXIT_CODE=$?
                echo "::error::âŒ Claude Codeå®Ÿè¡Œå¤±æ•— (exit code: $CLAUDE_EXIT_CODE)"
                if [ $CLAUDE_EXIT_CODE -eq 124 ]; then
                  echo "::error::âŒ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ (3åˆ†)"
                fi
                echo "::error::è©³ç´°ãªã‚¨ãƒ©ãƒ¼å‡ºåŠ›:"
                echo "$IMAGE_RESULT" | head -50
                echo "::error::ç’°å¢ƒå¤‰æ•°ç¢ºèª:"
                echo "CLAUDE_CODE_OAUTH_TOKEN: ${CLAUDE_CODE_OAUTH_TOKEN:0:20}..."
                IMAGE_RESULT=""
              }
          
          echo "ğŸ¨ ç”»åƒç”Ÿæˆçµæœ (è©³ç´°ãƒ­ã‚°):"
          echo "--- Claude Code å®Ÿè¡Œãƒ­ã‚° (é–‹å§‹) ---"
          echo "$IMAGE_RESULT"
          echo "--- Claude Code å®Ÿè¡Œãƒ­ã‚° (çµ‚äº†) ---"
          echo ""
          
          # çµæœã‹ã‚‰URLã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŠ½å‡º
          IMAGE_URL=$(echo "$IMAGE_RESULT" | grep -oP '(https://|gs://)[^\s]+\.(png|jpg|jpeg|webp)' | head -1)
          
          # request_idã®æŠ½å‡º
          REQUEST_ID=$(echo "$IMAGE_RESULT" | grep -oP 'request_id\s*`?([a-f0-9-]+)`?' | sed 's/.*`\?\([a-f0-9-]\+\)`\?.*/\1/' | head -1)
          if [ ! -z "$REQUEST_ID" ]; then
            echo "ğŸ” Request IDæ¤œå‡º: $REQUEST_ID"
            # request_idãŒã‚ã‚‹å ´åˆã¯ã€Claude Codeã«ç”»åƒå–å¾—ã‚’å†ä¾é ¼
            DOWNLOAD_PROMPT="request_id $REQUEST_ID ã‹ã‚‰ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€morning-image.pngã¨ã—ã¦ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚"
            echo "ğŸ”„ Request IDã‹ã‚‰ç”»åƒå–å¾—ã‚’è©¦è¡Œ..."
            DOWNLOAD_RESULT=$(timeout 60 npx @anthropic-ai/claude-code \
              --mcp-config="$(pwd)/mcp-config.json" \
              --allowedTools "mcp__nano-banana-edit-kamui__nano_banana_edit" \
              --max-turns 5 \
              --permission-mode "bypassPermissions" \
              --print \
              "$DOWNLOAD_PROMPT" 2>&1) || true
            echo "ğŸ“¥ ç”»åƒå–å¾—çµæœ: $DOWNLOAD_RESULT"
          fi
          
          # Claude Codeã®å‡ºåŠ›ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŠ½å‡ºï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
          CLAUDE_FILE=""
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³A: ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã¾ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«å
          CLAUDE_FILE=$(echo "$IMAGE_RESULT" | grep -oP '`[^`]+\.(png|jpg|jpeg|webp)`' | sed 's/`//g' | head -1)
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³B: ã€Œãƒ•ã‚¡ã‚¤ãƒ«å**: ã€å½¢å¼
          if [ -z "$CLAUDE_FILE" ]; then
            CLAUDE_FILE=$(echo "$IMAGE_RESULT" | grep -oP '\*\*ãƒ•ã‚¡ã‚¤ãƒ«å\*\*[:\s]*[^0-9\s]*[a-zA-Z0-9_]+\.(png|jpg|jpeg|webp)' | sed 's/\*\*ãƒ•ã‚¡ã‚¤ãƒ«å\*\*[:\s]*//' | head -1)
          fi
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³C: ã€Œç”»åƒã¯ã€ã§å§‹ã¾ã‚‹è¡Œã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åæŠ½å‡º
          if [ -z "$CLAUDE_FILE" ]; then
            CLAUDE_FILE=$(echo "$IMAGE_RESULT" | grep -oP 'ç”»åƒã¯[^/]*([/][^/\s]*)*[a-zA-Z0-9_]+\.(png|jpg|jpeg|webp)' | grep -oP '[a-zA-Z0-9_]+\.(png|jpg|jpeg|webp)' | head -1)
          fi
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³D: ã€Œãƒ•ã‚¡ã‚¤ãƒ«åã€Œã€ã¨ã—ã¦ä¿å­˜ã€å½¢å¼
          if [ -z "$CLAUDE_FILE" ]; then
            CLAUDE_FILE=$(echo "$IMAGE_RESULT" | grep -oP 'ãƒ•ã‚¡ã‚¤ãƒ«åã€Œ[^ã€]+\.(png|jpg|jpeg|webp)ã€ã¨ã—ã¦ä¿å­˜' | grep -oP '[^ã€Œ]+\.(png|jpg|jpeg|webp)' | head -1)
          fi
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³E: morning-image.pngãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç›´æ¥æ¤œç´¢
          if [ -z "$CLAUDE_FILE" ]; then
            CLAUDE_FILE=$(echo "$IMAGE_RESULT" | grep -oP '[A-Za-z_]*morning-image[a-zA-Z0-9_]*\.(png|jpg|jpeg|webp)' | head -1)
          fi
          
          # ãƒ•ã‚¡ã‚¤ãƒ«åã®å‰å¾Œã®ç©ºç™½ã‚’é™¤å»
          CLAUDE_FILE=$(echo "$CLAUDE_FILE" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          if [ ! -z "$CLAUDE_FILE" ]; then
            echo "âœ… Claude Codeã®å‡ºåŠ›ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ¤œå‡º: $CLAUDE_FILE"
          else
            echo "âš ï¸ Claude Codeã®å‡ºåŠ›ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ"
          fi
          echo "ğŸ” ãƒ‡ãƒãƒƒã‚°: CLAUDE_FILE='$CLAUDE_FILE'"
          IMAGE_FILE="morning-image.png"
          
          # ç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
          echo "ğŸ” ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ä¸­..."
          ls -la || true
          
          # è¤‡æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
          DOWNLOADED_FILE=""
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³0: Claude CodeãŒæ˜ç¤ºçš„ã«å‡ºåŠ›ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«å
          echo "ğŸ” ãƒ‘ã‚¿ãƒ¼ãƒ³0ãƒã‚§ãƒƒã‚¯: CLAUDE_FILE='$CLAUDE_FILE'"
          if [ ! -z "$CLAUDE_FILE" ]; then
            echo "ğŸ” CLAUDE_FILEãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ - ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ãƒã‚§ãƒƒã‚¯"
            if [ -f "$CLAUDE_FILE" ]; then
              DOWNLOADED_FILE="$CLAUDE_FILE"
              echo "âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³0ï¼ˆClaudeå‡ºåŠ›ï¼‰ã§ç™ºè¦‹: $DOWNLOADED_FILE"
            else
              echo "âš ï¸ ãƒ‘ã‚¿ãƒ¼ãƒ³0: ç›´æ¥ãƒ‘ã‚¹ã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“: $CLAUDE_FILE"
              # çµ¶å¯¾ãƒ‘ã‚¹ã®å ´åˆã€è¤‡æ•°ã®æ–¹æ³•ã§ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ
              if [[ "$CLAUDE_FILE" == /* ]]; then
                echo "ğŸ” çµ¶å¯¾ãƒ‘ã‚¹æ¤œå‡º - è¤‡æ•°ã®æ–¹æ³•ã§ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ"
                BASENAME_FILE=$(basename "$CLAUDE_FILE")
                echo "ğŸ” ãƒ•ã‚¡ã‚¤ãƒ«å: $BASENAME_FILE"
                
                # æ–¹æ³•1: ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹
                if [ -f "$CLAUDE_FILE" ]; then
                  echo "âœ… ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãƒ•ã‚¡ã‚¤ãƒ«ç™ºè¦‹: $CLAUDE_FILE"
                  if cp "$CLAUDE_FILE" "./$BASENAME_FILE" 2>/dev/null; then
                    DOWNLOADED_FILE="./$BASENAME_FILE"
                    echo "âœ… ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼å®Œäº†: $DOWNLOADED_FILE"
                  fi
                fi
                
                # æ–¹æ³•2: sudoã§ã‚¢ã‚¯ã‚»ã‚¹
                if [ -z "$DOWNLOADED_FILE" ] && sudo test -f "$CLAUDE_FILE" 2>/dev/null; then
                  echo "âœ… sudoæ¨©é™ã§çµ¶å¯¾ãƒ‘ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ç™ºè¦‹: $CLAUDE_FILE"
                  if sudo cp "$CLAUDE_FILE" "./$BASENAME_FILE" 2>/dev/null; then
                    sudo chown runner:docker "./$BASENAME_FILE" 2>/dev/null || true
                    DOWNLOADED_FILE="./$BASENAME_FILE"
                    echo "âœ… sudoæ¨©é™ã§çµ¶å¯¾ãƒ‘ã‚¹ã‹ã‚‰ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼å®Œäº†: $DOWNLOADED_FILE"
                  else
                    echo "::warning::âš ï¸ sudoã§ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼ã«å¤±æ•—"
                  fi
                fi
                
                # æ–¹æ³•3: ãƒ‘ã‚¹å†…æ¤œç´¢
                if [ -z "$DOWNLOADED_FILE" ]; then
                  echo "ğŸ” ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ å†…ã§ morning-image.png ã‚’æ¤œç´¢ä¸­..."
                  FOUND_FILE=$(find /home -name "morning-image.png" -type f 2>/dev/null | head -1)
                  if [ ! -z "$FOUND_FILE" ]; then
                    echo "âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æ¤œç´¢ã§ç™ºè¦‹: $FOUND_FILE"
                    if cp "$FOUND_FILE" "./$BASENAME_FILE" 2>/dev/null || sudo cp "$FOUND_FILE" "./$BASENAME_FILE" 2>/dev/null; then
                      sudo chown runner:docker "./$BASENAME_FILE" 2>/dev/null || true
                      DOWNLOADED_FILE="./$BASENAME_FILE"
                      echo "âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æ¤œç´¢ã‹ã‚‰ã‚³ãƒ”ãƒ¼å®Œäº†: $DOWNLOADED_FILE"
                    fi
                  else
                    echo "âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æ¤œç´¢ã§ã‚‚è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
                  fi
                fi
                
                if [ -z "$DOWNLOADED_FILE" ]; then
                  echo "::warning::âš ï¸ å…¨ã¦ã®æ–¹æ³•ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—"
                  echo "::warning::ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
                  echo "::warning::- pwd: $(pwd)"
                  echo "::warning::- ls /home/runner/work/ å†…å®¹:"
                  sudo ls -la /home/runner/work/ 2>/dev/null || echo "ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“"
                  echo "::warning::- findçµæœ:"
                  sudo find /home -name "*morning*" -type f 2>/dev/null | head -10 || echo "findã§ã‚¨ãƒ©ãƒ¼"
                fi
              fi
            fi
          else
            echo "ğŸ” CLAUDE_FILEãŒç©ºã§ã™"
          fi
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³1: morning-imageã§å§‹ã¾ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
          if [ -z "$DOWNLOADED_FILE" ]; then
            DOWNLOADED_FILE=$(find . -name "morning-image*.png" -o -name "morning-image*.jpg" -o -name "morning-image*.jpeg" -o -name "morning-image*.webp" -type f 2>/dev/null | head -1)
            [ ! -z "$DOWNLOADED_FILE" ] && echo "âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³1ã§ç™ºè¦‹: $DOWNLOADED_FILE"
          fi
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³1.5: Claude CodeãŒæŒ‡å®šã—ãŸæ­£ç¢ºãªãƒ•ã‚¡ã‚¤ãƒ«å
          if [ -z "$DOWNLOADED_FILE" ] && [ ! -z "$CLAUDE_FILE" ]; then
            BASENAME_FILE=$(basename "$CLAUDE_FILE")
            if [ -f "$BASENAME_FILE" ]; then
              DOWNLOADED_FILE="$BASENAME_FILE"
              echo "âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³1.5ã§ç™ºè¦‹ï¼ˆæ­£ç¢ºãªãƒ•ã‚¡ã‚¤ãƒ«åï¼‰: $DOWNLOADED_FILE"
            fi
          fi
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³2: imageã§å§‹ã¾ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
          if [ -z "$DOWNLOADED_FILE" ]; then
            DOWNLOADED_FILE=$(find . -name "image*.png" -o -name "image*.jpg" -o -name "image*.jpeg" -o -name "image*.webp" -type f 2>/dev/null | head -1)
            [ ! -z "$DOWNLOADED_FILE" ] && echo "âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³2ã§ç™ºè¦‹: $DOWNLOADED_FILE"
          fi
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³3: æœ€è¿‘ä½œæˆã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ5åˆ†ä»¥å†…ï¼‰
          if [ -z "$DOWNLOADED_FILE" ]; then
            DOWNLOADED_FILE=$(find . -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.webp" -type f -mmin -5 2>/dev/null | head -1)
            [ ! -z "$DOWNLOADED_FILE" ] && echo "âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³3ã§ç™ºè¦‹: $DOWNLOADED_FILE"
          fi
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³3.5: ã‚ˆã‚Šåºƒç¯„å›²ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æ¤œç´¢
          if [ -z "$DOWNLOADED_FILE" ]; then
            echo "ğŸ” ã‚ˆã‚Šåºƒç¯„å›²ã§ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ä¸­..."
            FOUND_FILES=$(find /home -name "morning-image.png" -o -name "image.png" -type f 2>/dev/null | head -3)
            if [ ! -z "$FOUND_FILES" ]; then
              echo "âœ… ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã§ç™ºè¦‹:"
              echo "$FOUND_FILES"
              DOWNLOADED_FILE=$(echo "$FOUND_FILES" | head -1)
              echo "âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³3.5ã§ç™ºè¦‹: $DOWNLOADED_FILE"
              # ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
              if cp "$DOWNLOADED_FILE" "./morning-image.png" 2>/dev/null || sudo cp "$DOWNLOADED_FILE" "./morning-image.png" 2>/dev/null; then
                sudo chown runner:docker "./morning-image.png" 2>/dev/null || true
                DOWNLOADED_FILE="./morning-image.png"
                echo "âœ… ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼å®Œäº†: $DOWNLOADED_FILE"
              fi
            fi
          fi
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³4: ä»»æ„ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«
          if [ -z "$DOWNLOADED_FILE" ]; then
            DOWNLOADED_FILE=$(find . -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.webp" -type f 2>/dev/null | head -1)
            [ ! -z "$DOWNLOADED_FILE" ] && echo "âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³4ã§ç™ºè¦‹: $DOWNLOADED_FILE"
          fi
          
          echo "ğŸ” URLæŠ½å‡ºçµæœ: '$IMAGE_URL'"
          echo "ğŸ“ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: '$DOWNLOADED_FILE'"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å„ªå…ˆï¼‰
          if [ ! -z "$DOWNLOADED_FILE" ] && [ -s "$DOWNLOADED_FILE" ]; then
            echo "âœ… æ—¢ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨: $DOWNLOADED_FILE"
            
            # çµ¶å¯¾ãƒ‘ã‚¹ã®å ´åˆã€ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
            if [[ "$DOWNLOADED_FILE" == /* ]]; then
              echo "ğŸ” çµ¶å¯¾ãƒ‘ã‚¹æ¤œå‡º - ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼ä¸­"
              BASENAME_FILE=$(basename "$DOWNLOADED_FILE")
              if cp "$DOWNLOADED_FILE" "./$BASENAME_FILE" 2>/dev/null; then
                DOWNLOADED_FILE="./$BASENAME_FILE"
                echo "âœ… çµ¶å¯¾ãƒ‘ã‚¹ã‹ã‚‰ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼å®Œäº†: $DOWNLOADED_FILE"
              else
                echo "::warning::âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼ã«å¤±æ•—"
              fi
            fi
            
            FILE_SIZE=$(stat -c%s "$DOWNLOADED_FILE")
            echo "ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${FILE_SIZE} bytes"
            
            # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
            FILE_TYPE=$(file "$DOWNLOADED_FILE")
            echo "ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—: $FILE_TYPE"
            
            # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ãƒã‚§ãƒƒã‚¯
            if echo "$FILE_TYPE" | grep -qE "(image|PNG|JPEG|WebP|data)" && [ $FILE_SIZE -gt 1000 ]; then
              echo "âœ… æœ‰åŠ¹ãªç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¨åˆ¤å®š"
              
              # PNGã«å¤‰æ›
              sudo apt-get update && sudo apt-get install -y imagemagick
              if convert "$DOWNLOADED_FILE" "morning-image.png" 2>/dev/null; then
                echo "âœ… ç”»åƒã‚’PNGå½¢å¼ã«å¤‰æ›æˆåŠŸ"
                echo "image-url=file://$(pwd)/$DOWNLOADED_FILE" >> $GITHUB_OUTPUT
                echo "image-file=morning-image.png" >> $GITHUB_OUTPUT
              else
                echo "::warning::âš ï¸ ImageMagickå¤‰æ›å¤±æ•—ã€å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨"
                cp "$DOWNLOADED_FILE" "morning-image.png"
                echo "image-url=file://$(pwd)/$DOWNLOADED_FILE" >> $GITHUB_OUTPUT
                echo "image-file=morning-image.png" >> $GITHUB_OUTPUT
              fi
            else
              echo "::warning::âš ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“"
              echo "::warning::ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—: $FILE_TYPE"
              echo "::warning::ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${FILE_SIZE} bytes"
              echo "::warning::ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰:"
              head -c 500 "$DOWNLOADED_FILE" || true
              echo ""
              
              # XMLã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å ´åˆã€å†…å®¹ã‚’è¡¨ç¤º
              if echo "$FILE_TYPE" | grep -qE "(XML|HTML|text)"; then
                echo "::warning::ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨ä½“:"
                cat "$DOWNLOADED_FILE" | head -20
              fi
              
              # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
              rm -f "$DOWNLOADED_FILE"
              DOWNLOADED_FILE=""
            fi
          else
            echo "::warning::âš ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
          
          # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡åŠ¹ã ã£ãŸå ´åˆã€URLã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã¿ã‚‹
          if [ -z "$DOWNLOADED_FILE" ] || [ ! -f "morning-image.png" ]; then
            if [ ! -z "$IMAGE_URL" ] && [[ "$IMAGE_URL" =~ ^https:// ]]; then
              echo "âœ… HTTPS URLã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’è©¦è¡Œ: $IMAGE_URL"
              
              # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
              if curl -L "$IMAGE_URL" -o "$IMAGE_FILE" --max-time 60; then
                if [ -s "$IMAGE_FILE" ]; then
                  FILE_SIZE=$(stat -c%s "$IMAGE_FILE")
                  FILE_TYPE=$(file "$IMAGE_FILE")
                  echo "ğŸ“Š ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${FILE_SIZE} bytes"
                  echo "ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—: $FILE_TYPE"
                  
                  # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ãƒã‚§ãƒƒã‚¯
                  if echo "$FILE_TYPE" | grep -qE "(image|PNG|JPEG|WebP|data)" && [ $FILE_SIZE -gt 1000 ]; then
                    echo "âœ… æœ‰åŠ¹ãªç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
                    
                    # PNGã«å¤‰æ›
                    sudo apt-get update && sudo apt-get install -y imagemagick
                    if convert "$IMAGE_FILE" "morning-image.png" 2>/dev/null; then
                      echo "âœ… ç”»åƒã‚’PNGå½¢å¼ã«å¤‰æ›æˆåŠŸ"
                      echo "image-url=$IMAGE_URL" >> $GITHUB_OUTPUT
                      echo "image-file=morning-image.png" >> $GITHUB_OUTPUT
                    else
                      echo "::warning::âš ï¸ ImageMagickå¤‰æ›å¤±æ•—ã€å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨"
                      mv "$IMAGE_FILE" "morning-image.png"
                      echo "image-url=$IMAGE_URL" >> $GITHUB_OUTPUT
                      echo "image-file=morning-image.png" >> $GITHUB_OUTPUT
                    fi
                  else
                    echo "::warning::âš ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“"
                    echo "::warning::ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰:"
                    head -c 500 "$IMAGE_FILE" || true
                    rm -f "$IMAGE_FILE"
                  fi
                else
                  echo "::warning::âš ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™"
                fi
              else
                echo "::warning::âš ï¸ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
              fi
            else
              echo "::warning::âš ï¸ æœ‰åŠ¹ãªURLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            fi
          fi
          
          # ç”»åƒç”ŸæˆæˆåŠŸãƒã‚§ãƒƒã‚¯
          if [ -f "morning-image.png" ] && [ -s "morning-image.png" ]; then
            echo "âœ… ç”»åƒç”ŸæˆæˆåŠŸï¼ˆè©¦è¡Œ $RETRY_COUNT/3ï¼‰"
            SUCCESS=true
            break
          else
            echo "::warning::âš ï¸ ç”»åƒç”Ÿæˆå¤±æ•—ï¼ˆè©¦è¡Œ $RETRY_COUNT/3ï¼‰"
            echo "::warning::è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ­ã‚°:"
            echo "::warning::Claude Codeå®Ÿè¡Œçµæœ: $IMAGE_RESULT"
            echo "::warning::æŠ½å‡ºã•ã‚ŒãŸURL: '$IMAGE_URL'"
            echo "::warning::ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: '$DOWNLOADED_FILE'"
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            rm -f morning-image.png image*.png *.png 2>/dev/null || true
            
            if [ $RETRY_COUNT -lt 3 ]; then
              echo "ğŸ”„ 30ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™..."
              sleep 30
            fi
          fi
        done
        
        # æœ€çµ‚çµæœãƒã‚§ãƒƒã‚¯
        if [ "$SUCCESS" != "true" ]; then
          echo "::error::âŒ ç”»åƒç”Ÿæˆã«3å›å¤±æ•—ã—ã¾ã—ãŸ"
          echo "::error::ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹:"
          ls -la || true
          echo "::error::MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
          if [ -f "mcp-config.json" ]; then
            echo "::error::MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™: mcp-config.json"
            head -20 "mcp-config.json" || true
          else
            echo "::error::MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: mcp-config.json"
          fi
          exit 1
        fi
        
        # æœ€çµ‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
        if [ -f "morning-image.png" ] && [ -s "morning-image.png" ]; then
          FINAL_SIZE=$(stat -c%s "morning-image.png")
          echo "âœ… æœ€çµ‚ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆå®Œäº† (${FINAL_SIZE} bytes)"
        else
          echo "::error::âŒ æœ€çµ‚ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
        fi
        
    - name: Upload Image artifact
      uses: actions/upload-artifact@v4
      with:
        name: morning-image
        path: morning-image.png
        retention-days: 1