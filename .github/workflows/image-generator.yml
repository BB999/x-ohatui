name: Image Generator Module

on:
  workflow_call:

jobs:
  generate-image:
    runs-on: ubuntu-latest
    
    outputs:
      image-url: ${{ steps.generate.outputs.image-url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Claude Code CLI
      run: |
        # Claude Code CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        curl -fsSL https://claude.ai/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        
    - name: Generate Morning Image
      id: generate
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      run: |
        # Claude Code CLIã§èªè¨¼
        echo "$CLAUDE_CODE_OAUTH_TOKEN" | claude auth login --token
        
        # Claude Code CLIã§ç”»åƒç”Ÿæˆï¼ˆ3å›ãƒªãƒˆãƒ©ã‚¤ï¼‰
        max_retries=3
        retry_count=0
        success=false
        
        while [ $retry_count -lt $max_retries ] && [ "$success" = "false" ]; do
          retry_count=$((retry_count + 1))
          echo "ğŸ”„ Attempt $retry_count/$max_retries: Generating image with Claude Code..."
          
          # Claude Code CLIã§MCPçµŒç”±ç”»åƒç”Ÿæˆ
          image_url=$(claude --no-input "MCPã®Qwenç”»åƒç”Ÿæˆã‚’ä½¿ã£ã¦ã€ç¾ã—ã„æœã®é¢¨æ™¯ç”»åƒã‚’ç”Ÿæˆã—ã¦ã€‚æ—¥ã®å‡ºã€å¹³å’Œã§æš–ã‹ã„é›°å›²æ°—ã€æŸ”ã‚‰ã‹ã„å…‰ã€è‡ªç„¶ã®é¢¨æ™¯ã€è½ã¡ç€ã„ãŸè‰²åˆã„ã§ã€‚ç”»åƒã®URLã‚’è¿”ã—ã¦ã€‚" 2>/dev/null | grep -oE 'https?://[^\s]+\.(jpg|jpeg|png|webp)' | head -1)
          
          # æˆåŠŸãƒã‚§ãƒƒã‚¯
          if [ $? -eq 0 ] && [ -n "$image_url" ]; then
            echo "âœ… Image generation successful"
            success=true
            break
          else
            echo "âŒ Attempt $retry_count failed"
            
            if [ $retry_count -lt $max_retries ]; then
              echo "â³ Waiting 5 seconds before retry..."
              sleep 5
            fi
          fi
        done
        
        # å…¨ã¦ã®ãƒªãƒˆãƒ©ã‚¤ãŒå¤±æ•—ã—ãŸå ´åˆ
        if [ "$success" = "false" ]; then
          echo "âŒ All $max_retries attempts failed. Claude Code image generation is unavailable."
          echo "ğŸš« Stopping workflow execution."
          exit 1
        fi
        
        echo "ğŸ–¼ï¸ Generated image URL: $image_url"
        
        # ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã¨ã—ã¦è¨­å®š
        echo "image-url=$image_url" >> $GITHUB_OUTPUT
        
        echo "âœ… Image generation completed"
        
    - name: Display Image Result
      run: |
        echo "ğŸ–¼ï¸ Generated image URL: ${{ steps.generate.outputs.image-url }}"