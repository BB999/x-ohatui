name: Image Generator Module

on:
  workflow_call:

jobs:
  generate-image:
    runs-on: ubuntu-latest
    
    outputs:
      image-url: ${{ steps.generate.outputs.image-url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install Claude Code SDK
      run: npm install @anthropic-ai/claude-code
        
    - name: Generate Morning Image
      id: generate
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        QWEN_IMAGE: ${{ secrets.QWEN_IMAGE }}
      run: |
        # QWEN_IMAGE URLã®ç¢ºèª
        if [ -z "$QWEN_IMAGE" ]; then
          echo "::error::QWEN_IMAGE is not set in GitHub Secrets"
          exit 1
        fi
        echo "âœ… QWEN_IMAGE URL is configured"
        
        # MCPè¨­å®šã‚’ä½œæˆ
        echo '{
          "mcpServers": {
            "t2i-kamui-qwen-image": {
              "type": "http",
              "url": "'${QWEN_IMAGE}'",
              "description": "Qwen-Image Text-to-Image via Kamui Code"
            }
          }
        }' > mcp-config.json
        
        # ç”»åƒç”Ÿæˆãƒªãƒˆãƒ©ã‚¤ãƒ«ãƒ¼ãƒ—ï¼ˆæœ€å¤§3å›ï¼‰
        SUCCESS=false
        for RETRY_COUNT in {1..3}; do
          echo "ğŸ”„ ç”»åƒç”Ÿæˆè©¦è¡Œ $RETRY_COUNT/3"
          
          PROMPT="ç¾ã—ã„æœã®é¢¨æ™¯ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚æ—¥ã®å‡ºã€å¹³å’Œã§æš–ã‹ã„é›°å›²æ°—ã€æŸ”ã‚‰ã‹ã„å…‰ã€è‡ªç„¶ã®é¢¨æ™¯ã€è½ã¡ç€ã„ãŸè‰²åˆã„ã§ã€‚ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã¯æ­£æ–¹å½¢(square)ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«åã¯morning-image.pngã¨ã—ã¦ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚"
          
          echo "ğŸ¤– Claude Code SDKå®Ÿè¡Œé–‹å§‹"
          
          # Claude Code SDKã®å®Ÿè¡Œ
          IMAGE_RESULT=$(timeout 180 npx @anthropic-ai/claude-code \
            --mcp-config="$(pwd)/mcp-config.json" \
            --allowedTools "mcp__t2i-kamui-qwen-image" \
            --max-turns 8 \
            --permission-mode "acceptEdits" \
            --print \
            "$PROMPT" 2>&1) || {
                CLAUDE_EXIT_CODE=$?
                echo "::error::âŒ Claude Codeå®Ÿè¡Œå¤±æ•— (exit code: $CLAUDE_EXIT_CODE)"
                if [ $CLAUDE_EXIT_CODE -eq 124 ]; then
                  echo "::error::âŒ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ (3åˆ†)"
                fi
                IMAGE_RESULT=""
              }
          
          echo "ğŸ¨ ç”»åƒç”Ÿæˆçµæœ:"
          echo "$IMAGE_RESULT"
          
          # çµæœã‹ã‚‰URLã‚’æŠ½å‡º
          IMAGE_URL=$(echo "$IMAGE_RESULT" | grep -oP 'https://[^\s]+\.(png|jpg|jpeg|webp)' | head -1)
          
          # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
          DOWNLOADED_FILE=""
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³1: morning-image.*
          DOWNLOADED_FILE=$(find . -name "morning-image.*" -type f 2>/dev/null | head -1)
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³2: æœ€è¿‘ä½œæˆã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«
          if [ -z "$DOWNLOADED_FILE" ]; then
            DOWNLOADED_FILE=$(find . -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.webp" -type f -mmin -5 2>/dev/null | head -1)
          fi
          
          echo "ğŸ” URLæŠ½å‡ºçµæœ: '$IMAGE_URL'"
          echo "ğŸ“ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: '$DOWNLOADED_FILE'"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
          if [ ! -z "$DOWNLOADED_FILE" ] && [ -s "$DOWNLOADED_FILE" ]; then
            echo "âœ… æ—¢ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨: $DOWNLOADED_FILE"
            
            FILE_SIZE=$(stat -c%s "$DOWNLOADED_FILE")
            FILE_TYPE=$(file "$DOWNLOADED_FILE")
            
            # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ãƒã‚§ãƒƒã‚¯
            if echo "$FILE_TYPE" | grep -qE "(image|PNG|JPEG|WebP)" && [ $FILE_SIZE -gt 1000 ]; then
              echo "âœ… æœ‰åŠ¹ãªç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¨åˆ¤å®š"
              
              # morning-image.pngã«å¤‰æ›/ã‚³ãƒ”ãƒ¼
              if cp "$DOWNLOADED_FILE" "morning-image.png" 2>/dev/null; then
                echo "âœ… ç”»åƒã‚’morning-image.pngã«ä¿å­˜æˆåŠŸ"
                SUCCESS=true
                break
              fi
            fi
          elif [ ! -z "$IMAGE_URL" ] && [[ "$IMAGE_URL" =~ ^https:// ]]; then
            echo "âœ… HTTPS URLã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’è©¦è¡Œ: $IMAGE_URL"
            
            if curl -L "$IMAGE_URL" -o "morning-image.png" --max-time 60; then
              if [ -s "morning-image.png" ]; then
                FILE_SIZE=$(stat -c%s "morning-image.png")
                echo "ğŸ“Š ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${FILE_SIZE} bytes"
                
                if [ $FILE_SIZE -gt 1000 ]; then
                  echo "âœ… æœ‰åŠ¹ãªç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
                  SUCCESS=true
                  break
                fi
              fi
            fi
          fi
          
          echo "::warning::âš ï¸ ç”»åƒç”Ÿæˆå¤±æ•—ï¼ˆè©¦è¡Œ $RETRY_COUNT/3ï¼‰"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          rm -f morning-image.png *.png 2>/dev/null || true
          
          if [ $RETRY_COUNT -lt 3 ]; then
            echo "ğŸ”„ 5ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™..."
            sleep 5
          fi
        done
        
        # æœ€çµ‚çµæœãƒã‚§ãƒƒã‚¯
        if [ "$SUCCESS" != "true" ]; then
          echo "::error::âŒ ç”»åƒç”Ÿæˆã«3å›å¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
        fi
        
        # æœ€çµ‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
        if [ -f "morning-image.png" ] && [ -s "morning-image.png" ]; then
          FINAL_SIZE=$(stat -c%s "morning-image.png")
          echo "âœ… æœ€çµ‚ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆå®Œäº† (${FINAL_SIZE} bytes)"
        else
          echo "::error::âŒ æœ€çµ‚ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
        fi
        
        # ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã¨ã—ã¦è¨­å®š
        if [ ! -z "$IMAGE_URL" ]; then
          echo "image-url=$IMAGE_URL" >> $GITHUB_OUTPUT
        else
          echo "image-url=file://$(pwd)/morning-image.png" >> $GITHUB_OUTPUT
        fi
        
        echo "âœ… Image generation completed"
        
    - name: Display Image Result
      run: |
        echo "ğŸ–¼ï¸ Generated image: ${{ steps.generate.outputs.image-url }}"