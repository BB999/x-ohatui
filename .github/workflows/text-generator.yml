name: Text Generator Module

on:
  workflow_call:
    outputs:
      mamehina-dialogue:
        description: 'まめひなたのセリフ'
        value: ${{ jobs.generate-text.outputs.mamehina-dialogue }}
      pose-description:
        description: '変なポーズの詳細'
        value: ${{ jobs.generate-text.outputs.pose-description }}

jobs:
  generate-text:
    runs-on: ubuntu-latest
    
    outputs:
      mamehina-dialogue: ${{ steps.generate.outputs.mamehina-dialogue }}
      pose-description: ${{ steps.generate.outputs.pose-description }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install Claude Code SDK
      run: npm install @anthropic-ai/claude-code
        
    - name: Generate Morning Greeting Text
      id: generate
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      run: |
        # Claude Code SDKでおはようテキストを生成（3回リトライ）
        max_retries=3
        retry_count=0
        success=false
        
        WORK_DIR="text-work"
        mkdir -p "$WORK_DIR"
        
        while [ $retry_count -lt $max_retries ] && [ "$success" = "false" ]; do
          retry_count=$((retry_count + 1))
          echo "🔄 Attempt $retry_count/$max_retries: Generating text with Claude Code SDK..."
          
          # ランダムな要素を生成
          time_patterns=("朝の光" "新しい一日" "清々しい朝" "爽やかな朝" "素晴らしい朝" "輝く朝")
          styles=("温かく" "親しみやすく" "優しく" "明るく" "穏やかに" "元気よく")
          approaches=("季節感を込めて" "希望を込めて" "感謝の気持ちで" "前向きな気持ちで" "心を込めて" "愛情を込めて")

          # （内容2向け）ポーズ記述にランダム性を持たせるための候補
          pose_archetypes=(
            "Dynamic, wide-legged power stance"
            "Graceful contrapposto with weight on one leg"
            "Exaggerated twist with shoulder-forward, hips-back"
            "Leaning forward with one hand extended"
            "Arms crossed dramatically, chin raised"
            "Knees bent low, hands on hips"
            "Mid-air jump with tucked knees"
          )
          camera_angles=(
            "low angle (worm's-eye view) to emphasize power"
            "high angle (bird's-eye view) for dynamism"
            "three-quarter view from the left"
            "frontal close-up"
            "over-the-shoulder from behind"
          )
          compositions=(
            "strong silhouette and S-curve"
            "diagonal composition with leading lines"
            "rule-of-thirds emphasis"
            "asymmetrical balance"
            "foreground hand foreshortening"
          )
          # 表情とムードはポーズに整合させる（後段のcaseで決定）
          
          # ランダムに選択
          time_idx=$((RANDOM % ${#time_patterns[@]}))
          style_idx=$((RANDOM % ${#styles[@]}))
          approach_idx=$((RANDOM % ${#approaches[@]}))

          pose_idx=$((RANDOM % ${#pose_archetypes[@]}))
          angle_idx=$((RANDOM % ${#camera_angles[@]}))
          comp_idx=$((RANDOM % ${#compositions[@]}))
          
          selected_time="${time_patterns[$time_idx]}"
          selected_style="${styles[$style_idx]}"
          selected_approach="${approaches[$approach_idx]}"
          selected_pose="${pose_archetypes[$pose_idx]}"
          selected_angle="${camera_angles[$angle_idx]}"
          selected_comp="${compositions[$comp_idx]}"

          # ポーズに基づいて表情とムードを合わせる
          case "$selected_pose" in
            "Dynamic, wide-legged power stance")
              selected_mood="determined and radiant"
              selected_face="bright smile, eyes sparkling"
              ;;
            "Graceful contrapposto with weight on one leg")
              selected_mood="calm yet resolute"
              selected_face="gentle smile, soft eyes"
              ;;
            "Exaggerated twist with shoulder-forward, hips-back")
              selected_mood="cheerful and energetic"
              selected_face="wide grin, eyebrows raised"
              ;;
            "Leaning forward with one hand extended")
              selected_mood="mischievous but charming"
              selected_face="slight smirk, eyes narrowed"
              ;;
            "Arms crossed dramatically, chin raised")
              selected_mood="determined and radiant"
              selected_face="slight smirk, eyes narrowed"
              ;;
            "Knees bent low, hands on hips")
              selected_mood="cheerful and energetic"
              selected_face="bright smile, eyes sparkling"
              ;;
            "Mid-air jump with tucked knees")
              selected_mood="cheerful and energetic"
              selected_face="open-mouthed laugh, eyes curved"
              ;;
            *)
              selected_mood="confident and playful"
              selected_face="bright smile, eyes sparkling"
              ;;
          esac
          
          echo "🎲 Selected elements: $selected_time, $selected_style, $selected_approach"
          echo "🎯 Pose constraints: $selected_pose | $selected_angle | $selected_mood | $selected_comp | $selected_face"
          
          PROMPT="まめひなたのセリフと変なポーズの詳細を生成してください。

          キャラクター設定：
          - まめひなた：明るく元気

          生成する内容：
          1. まめひなたのセリフ（40字程度）- 明るく元気な感じ
          2. かっこいいポーズと表情の詳細を英語で出力（100-300字程度）。以下の条件を必ず反映すること（英語で統合して自然な文章にする）：
             - Pose archetype: $selected_pose
             - Camera angle: $selected_angle
             - Mood: $selected_mood
             - Composition: $selected_comp
             - Facial detail: $selected_face

          以下のJSONファイルを morning_text.json として現在のディレクトリに保存してください：
          {
            \"mamehina\": \"まめひなたのセリフ\",
            \"pose\": \"変なポーズの詳細説明\"
          }
          
          **重要**: Writeツールを使用してファイルを確実に保存してください。"
          
          cd "$WORK_DIR" && npx @anthropic-ai/claude-code \
            --allowedTools "Write" \
            --max-turns 5 \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          # 元のディレクトリに戻る
          cd - > /dev/null 2>&1
          
          # 成功チェック
          if [ -f "$WORK_DIR/morning_text.json" ]; then
            mamehina_dialogue=$(jq -r '.mamehina' "$WORK_DIR/morning_text.json" 2>/dev/null)
            pose_description=$(jq -r '.pose' "$WORK_DIR/morning_text.json" 2>/dev/null)
            
            if [ -n "$mamehina_dialogue" ] && [ "$mamehina_dialogue" != "null" ]; then
              echo "✅ Text generation successful"
              echo "👧 まめひなた: $mamehina_dialogue"
              echo "🤸 ポーズ: $pose_description"
              success=true
              break
            fi
          fi
          
          echo "❌ Attempt $retry_count failed"
          
          if [ $retry_count -lt $max_retries ]; then
            echo "⏳ Waiting 5 seconds before retry..."
            sleep 5
          fi
        done
        
        # 全てのリトライが失敗した場合
        if [ "$success" = "false" ]; then
          echo "❌ All $max_retries attempts failed. Claude Code is unavailable."
          echo "🚫 Stopping workflow execution."
          exit 1
        fi
        
        echo "✅ Content generation successful"
        
        # アウトプットとして設定
        echo "mamehina-dialogue=$mamehina_dialogue" >> $GITHUB_OUTPUT
        echo "pose-description=$pose_description" >> $GITHUB_OUTPUT
        
        echo "📊 Generated outputs:"
        echo "  - まめひなた: $mamehina_dialogue"
        echo "  - ポーズ: $pose_description"
        
    - name: Display Result
      run: |
        echo "🎬 Generated dialogue and pose:"
        echo "まめひなた: ${{ steps.generate.outputs.mamehina-dialogue }}"
        echo "ポーズ: ${{ steps.generate.outputs.pose-description }}"
        
    - name: Save Text as Artifact
      run: |
        echo "${{ steps.generate.outputs.mamehina-dialogue }}" > mamehina-dialogue.txt
        echo "${{ steps.generate.outputs.pose-description }}" > pose-description.txt
        echo "📄 Saved all text files"
        
    - name: Upload Text Artifact
      uses: actions/upload-artifact@v4
      with:
        name: morning-content
        path: |
          mamehina-dialogue.txt
          pose-description.txt
        retention-days: 1
