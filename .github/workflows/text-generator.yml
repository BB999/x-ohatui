name: Text Generator Module

on:
  workflow_call:
    outputs:
      scene-description:
        description: 'ç”»åƒã®ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³èª¬æ˜Ž'
        value: ${{ jobs.generate-text.outputs.scene-description }}
      mamehina-dialogue:
        description: 'ã¾ã‚ã²ãªãŸã®ã‚»ãƒªãƒ•'
        value: ${{ jobs.generate-text.outputs.mamehina-dialogue }}
      kipferl-dialogue:
        description: 'ã‚­ãƒ—ãƒ•ã‚§ãƒ«ã®ã‚»ãƒªãƒ•'
        value: ${{ jobs.generate-text.outputs.kipferl-dialogue }}

jobs:
  generate-text:
    runs-on: ubuntu-latest
    
    outputs:
      scene-description: ${{ steps.generate.outputs.scene-description }}
      mamehina-dialogue: ${{ steps.generate.outputs.mamehina-dialogue }}
      kipferl-dialogue: ${{ steps.generate.outputs.kipferl-dialogue }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install Claude Code SDK
      run: npm install @anthropic-ai/claude-code
        
    - name: Generate Morning Greeting Text
      id: generate
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      run: |
        # Claude Code SDKã§ãŠã¯ã‚ˆã†ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆï¼ˆ3å›žãƒªãƒˆãƒ©ã‚¤ï¼‰
        max_retries=3
        retry_count=0
        success=false
        
        WORK_DIR="text-work"
        mkdir -p "$WORK_DIR"
        
        while [ $retry_count -lt $max_retries ] && [ "$success" = "false" ]; do
          retry_count=$((retry_count + 1))
          echo "ðŸ”„ Attempt $retry_count/$max_retries: Generating text with Claude Code SDK..."
          
          # ãƒ©ãƒ³ãƒ€ãƒ ãªè¦ç´ ã‚’ç”Ÿæˆ
          time_patterns=("æœã®å…‰" "æ–°ã—ã„ä¸€æ—¥" "æ¸…ã€…ã—ã„æœ" "çˆ½ã‚„ã‹ãªæœ" "ç´ æ™´ã‚‰ã—ã„æœ" "è¼ãæœ")
          styles=("æ¸©ã‹ã" "è¦ªã—ã¿ã‚„ã™ã" "å„ªã—ã" "æ˜Žã‚‹ã" "ç©ã‚„ã‹ã«" "å…ƒæ°—ã‚ˆã")
          approaches=("å­£ç¯€æ„Ÿã‚’è¾¼ã‚ã¦" "å¸Œæœ›ã‚’è¾¼ã‚ã¦" "æ„Ÿè¬ã®æ°—æŒã¡ã§" "å‰å‘ããªæ°—æŒã¡ã§" "å¿ƒã‚’è¾¼ã‚ã¦" "æ„›æƒ…ã‚’è¾¼ã‚ã¦")
          
          # ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠžï¼ˆç¾åœ¨æ™‚åˆ»ã‚’ã‚·ãƒ¼ãƒ‰å€¤ã¨ã—ã¦ä½¿ç”¨ï¼‰
          seed=$(date +%s%N)
          time_idx=$((seed % ${#time_patterns[@]}))
          style_idx=$(((seed / 1000) % ${#styles[@]}))
          approach_idx=$(((seed / 1000000) % ${#approaches[@]}))
          
          selected_time="${time_patterns[$time_idx]}"
          selected_style="${styles[$style_idx]}"
          selected_approach="${approaches[$approach_idx]}"
          
          echo "ðŸŽ² Selected elements: $selected_time, $selected_style, $selected_approach"
          
          PROMPT="æœã®ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚»ãƒªãƒ•ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šï¼š
          - ã¾ã‚ã²ãªãŸï¼šãƒ„ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ«ã®å¥³å­é«˜ç”Ÿã€æ˜Žã‚‹ãå…ƒæ°—
          - ã‚­ãƒ—ãƒ•ã‚§ãƒ«ï¼šä¸‰æ¯›çŒ«ã€ã®ã‚“ã³ã‚Šå±‹ã§ã¡ã‚‡ã£ã¨ãƒ„ãƒ³ãƒ‡ãƒ¬

          ç”Ÿæˆã™ã‚‹å†…å®¹ï¼š
          1. ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³èª¬æ˜Žï¼ˆ100å­—ç¨‹åº¦ï¼‰- ä¾‹ï¼šæ•™å®¤ã§æœã®æº–å‚™ã€å…¬åœ’ã§æœã®æ•£æ­©ã€ã‚­ãƒƒãƒãƒ³ã§æœé£Ÿæº–å‚™ãªã©
          2. ã¾ã‚ã²ãªãŸã®ã‚»ãƒªãƒ•ï¼ˆ20å­—ç¨‹åº¦ï¼‰- æ˜Žã‚‹ãå…ƒæ°—ãªæ„Ÿã˜
          3. ã‚­ãƒ—ãƒ•ã‚§ãƒ«ã®ã‚»ãƒªãƒ•ï¼ˆ20å­—ç¨‹åº¦ï¼‰- çŒ«ã‚‰ã—ãã®ã‚“ã³ã‚Š

          ä»¥ä¸‹ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ morning_text.json ã¨ã—ã¦ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
          {
            \"scene\": \"ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³èª¬æ˜Ž\",
            \"mamehina\": \"ã¾ã‚ã²ãªãŸã®ã‚»ãƒªãƒ•\",
            \"kipferl\": \"ã‚­ãƒ—ãƒ•ã‚§ãƒ«ã®ã‚»ãƒªãƒ•\"
          }
          
          **é‡è¦**: Writeãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºå®Ÿã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚"
          
          cd "$WORK_DIR" && npx @anthropic-ai/claude-code \
            --allowedTools "Write" \
            --max-turns 5 \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          # å…ƒã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æˆ»ã‚‹
          cd - > /dev/null 2>&1
          
          # æˆåŠŸãƒã‚§ãƒƒã‚¯
          if [ -f "$WORK_DIR/morning_text.json" ]; then
            scene_description=$(jq -r '.scene' "$WORK_DIR/morning_text.json" 2>/dev/null)
            mamehina_dialogue=$(jq -r '.mamehina' "$WORK_DIR/morning_text.json" 2>/dev/null)
            kipferl_dialogue=$(jq -r '.kipferl' "$WORK_DIR/morning_text.json" 2>/dev/null)
            
            if [ -n "$scene_description" ] && [ "$scene_description" != "null" ]; then
              echo "âœ… Text generation successful"
              echo "ðŸŽ¬ Scene: $scene_description"
              echo "ðŸ‘§ ã¾ã‚ã²ãªãŸ: $mamehina_dialogue"
              echo "ðŸ± ã‚­ãƒ—ãƒ•ã‚§ãƒ«: $kipferl_dialogue"
              success=true
              break
            fi
          fi
          
          echo "âŒ Attempt $retry_count failed"
          
          if [ $retry_count -lt $max_retries ]; then
            echo "â³ Waiting 5 seconds before retry..."
            sleep 5
          fi
        done
        
        # å…¨ã¦ã®ãƒªãƒˆãƒ©ã‚¤ãŒå¤±æ•—ã—ãŸå ´åˆ
        if [ "$success" = "false" ]; then
          echo "âŒ All $max_retries attempts failed. Claude Code is unavailable."
          echo "ðŸš« Stopping workflow execution."
          exit 1
        fi
        
        echo "âœ… Content generation successful"
        
        # ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã¨ã—ã¦è¨­å®š
        echo "scene-description=$scene_description" >> $GITHUB_OUTPUT
        echo "mamehina-dialogue=$mamehina_dialogue" >> $GITHUB_OUTPUT
        echo "kipferl-dialogue=$kipferl_dialogue" >> $GITHUB_OUTPUT
        
        echo "ðŸ“Š Generated outputs:"
        echo "  - Scene: $scene_description"
        echo "  - ã¾ã‚ã²ãªãŸ: $mamehina_dialogue"
        echo "  - ã‚­ãƒ—ãƒ•ã‚§ãƒ«: $kipferl_dialogue"
        
    - name: Display Result
      run: |
        echo "ðŸŽ¬ Generated scene and dialogues:"
        echo "Scene: ${{ steps.generate.outputs.scene-description }}"
        echo "ã¾ã‚ã²ãªãŸ: ${{ steps.generate.outputs.mamehina-dialogue }}"
        echo "ã‚­ãƒ—ãƒ•ã‚§ãƒ«: ${{ steps.generate.outputs.kipferl-dialogue }}"
        
    - name: Save Text as Artifact
      run: |
        echo "${{ steps.generate.outputs.scene-description }}" > scene-description.txt
        echo "${{ steps.generate.outputs.mamehina-dialogue }}" > mamehina-dialogue.txt
        echo "${{ steps.generate.outputs.kipferl-dialogue }}" > kipferl-dialogue.txt
        echo "ðŸ“„ Saved all text files"
        
    - name: Upload Text Artifact
      uses: actions/upload-artifact@v4
      with:
        name: morning-content
        path: |
          scene-description.txt
          mamehina-dialogue.txt
          kipferl-dialogue.txt
        retention-days: 1