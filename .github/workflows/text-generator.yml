name: Text Generator Module

on:
  workflow_call:

jobs:
  generate-text:
    runs-on: ubuntu-latest
    
    outputs:
      morning-text: ${{ steps.generate.outputs.morning-text }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Claude Code CLI
      run: |
        # Claude Code CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        curl -fsSL https://claude.ai/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        
    - name: Generate Morning Greeting Text
      id: generate
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      run: |
        # Claude Code CLIã§èªè¨¼
        echo "$CLAUDE_CODE_OAUTH_TOKEN" | claude auth login --token
        
        # Claude Code CLIã§ãŠã¯ã‚ˆã†ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆï¼ˆ3å›ãƒªãƒˆãƒ©ã‚¤ï¼‰
        max_retries=3
        retry_count=0
        success=false
        
        while [ $retry_count -lt $max_retries ] && [ "$success" = "false" ]; do
          retry_count=$((retry_count + 1))
          echo "ğŸ”„ Attempt $retry_count/$max_retries: Generating text with Claude Code..."
          
          # Claude Code CLIã§ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
          morning_text=$(claude --no-input "æ—¥æœ¬èªã§ç´ æ•µãªãŠã¯ã‚ˆã†ã®æŒ¨æ‹¶ã‚’1ã¤ä½œã£ã¦ã€‚20æ–‡å­—ä»¥å†…ã§ã€æ¸©ã‹ã¿ãŒã‚ã£ã¦è¦ªã—ã¿ã‚„ã™ã„æ„Ÿã˜ã§ã€‚çµµæ–‡å­—ã¯ä½¿ã‚ãªã„ã§ã€‚" 2>/dev/null)
          
          # æˆåŠŸãƒã‚§ãƒƒã‚¯
          if [ $? -eq 0 ] && [ -n "$morning_text" ]; then
            echo "âœ… Text generation successful"
            success=true
            break
          else
            echo "âŒ Attempt $retry_count failed"
            
            if [ $retry_count -lt $max_retries ]; then
              echo "â³ Waiting 5 seconds before retry..."
              sleep 5
            fi
          fi
        done
        
        # å…¨ã¦ã®ãƒªãƒˆãƒ©ã‚¤ãŒå¤±æ•—ã—ãŸå ´åˆ
        if [ "$success" = "false" ]; then
          echo "âŒ All $max_retries attempts failed. Claude Code is unavailable."
          echo "ğŸš« Stopping workflow execution."
          exit 1
        fi
        
        echo "Generated text: $morning_text"
        
        # æ–‡å­—æ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆ20æ–‡å­—ä»¥å†…ï¼‰
        char_count=$(echo -n "$morning_text" | wc -m)
        echo "Character count: $char_count"
        
        if [ "$char_count" -gt 20 ]; then
          echo "âš ï¸ Text too long ($char_count chars), truncating..."
          morning_text=$(echo "$morning_text" | cut -c1-20)
        fi
        
        echo "ğŸ“ Final morning greeting: $morning_text"
        
        # ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã¨ã—ã¦è¨­å®š
        echo "morning-text=$morning_text" >> $GITHUB_OUTPUT
        
        echo "âœ… Morning text generation completed"
        
    - name: Display Result
      run: |
        echo "ğŸ“ Generated morning greeting: ${{ steps.generate.outputs.morning-text }}"
        echo "Character count: $(echo -n "${{ steps.generate.outputs.morning-text }}" | wc -m)"