name: Discord Sender Module

on:
  workflow_call:
    inputs:
      message:
        description: 'Discordã«é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸'
        required: true
        type: string
      file-path:
        description: 'é€ä¿¡ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string
      embed-title:
        description: 'åŸ‹ã‚è¾¼ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string
      embed-description:
        description: 'åŸ‹ã‚è¾¼ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®èª¬æ˜ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string
      embed-color:
        description: 'åŸ‹ã‚è¾¼ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è‰²ï¼ˆ16é€²æ•°ã€ä»»æ„ï¼‰'
        required: false
        type: string
        default: '0099ff'

jobs:
  send-to-discord:
    runs-on: ubuntu-latest
    
    steps:
    - name: Download Image Artifact
      if: ${{ inputs.file-path == '' }}
      uses: actions/download-artifact@v4
      with:
        name: morning-image
        path: ./
      continue-on-error: true
      
    - name: Check Downloaded Files
      run: |
        echo "ğŸ“ Checking for images..."
        ls -la ./ | grep -E "\.(png|jpg|jpeg|gif)" || echo "No image files found"
        if [ -f "morning-image.png" ]; then
          echo "âœ… Image file found: morning-image.png"
          echo "ğŸ“Š File size: $(stat -c%s morning-image.png 2>/dev/null || stat -f%z morning-image.png) bytes"
        fi
        
    - name: Debug Inputs
      run: |
        echo "ğŸ” Discord Sender Debug:"
        echo "Message received: '${{ inputs.message }}'"
        echo "Message is not empty: ${{ inputs.message != '' }}"
        
    - name: Send message to Discord
      if: ${{ inputs.message != '' }}
      run: |
        echo "ğŸ“¤ Sending message to Discord..."
        
        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿é€ä¿¡ï¼ˆç”»åƒURLã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã«å«ã¾ã‚Œã‚‹ï¼‰
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          -H "Content-Type: application/json" \
          -d "{\"content\": \"${{ inputs.message }}\"}" \
          "${{ secrets.DISCORD_WEBHOOK_URL }}")
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
        BODY=$(echo "$RESPONSE" | head -n -1)
        
        echo "HTTP Status: $HTTP_CODE"
        
        if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
          echo "âœ… Message sent to Discord successfully"
        else
          echo "âŒ Failed to send message to Discord (HTTP $HTTP_CODE)"
          echo "Response: $BODY"
          exit 1
        fi
        
    - name: Send embed to Discord
      if: ${{ inputs.embed-title != '' && inputs.embed-description != '' }}
      run: |
        curl -H "Content-Type: application/json" \
             -d "{\"embeds\": [{\"title\": \"${{ inputs.embed-title }}\", \"description\": \"${{ inputs.embed-description }}\", \"color\": ${{ inputs.embed-color }}, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"}]}" \
             "${{ secrets.DISCORD_WEBHOOK_URL }}"