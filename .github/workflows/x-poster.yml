name: X (Twitter) Poster Module

on:
  workflow_call:
    inputs:
      tweet-text:
        required: true
        type: string
        description: "Tweet text content"
      image-file:
        required: false
        type: string
        description: "Image file path to attach"

jobs:
  post-to-x:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Download Image artifact (if needed)
      if: inputs.image-file != ''
      uses: actions/download-artifact@v4
      with:
        name: morning-image
        path: ./
        
    - name: Verify Files
      run: |
        echo "ğŸ“‹ ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªä¸­..."
        ls -la
        if [ "${{ inputs.image-file }}" != "" ]; then
          if [ -f "${{ inputs.image-file }}" ]; then
            echo "âœ… ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª: ${{ inputs.image-file }}"
            file "${{ inputs.image-file }}"
            echo "ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(stat -c%s "${{ inputs.image-file }}") bytes"
          else
            echo "::error::âŒ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${{ inputs.image-file }}"
            exit 1
          fi
        fi
        
    - name: Post to X (Twitter)
      env:
        X_API_KEY: ${{ secrets.X_API_KEY }}
        X_API_SECRET: ${{ secrets.X_API_SECRET }}
        X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
        X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
      run: |
        echo "ğŸ¦ X (Twitter) æŠ•ç¨¿é–‹å§‹"
        echo ""
        echo "æŠ•ç¨¿å†…å®¹: ${{ inputs.tweet-text }}"
        
        # å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã®ãƒã‚§ãƒƒã‚¯
        if [ -z "$X_API_KEY" ] || [ -z "$X_API_SECRET" ] || [ -z "$X_ACCESS_TOKEN" ] || [ -z "$X_ACCESS_TOKEN_SECRET" ]; then
          echo "::error::âŒ X APIèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
          echo "::error::ä»¥ä¸‹ã®GitHub Secretsã‚’è¨­å®šã—ã¦ãã ã•ã„:"
          echo "::error::  - X_API_KEY"
          echo "::error::  - X_API_SECRET"  
          echo "::error::  - X_ACCESS_TOKEN"
          echo "::error::  - X_ACCESS_TOKEN_SECRET"
          exit 1
        fi
        echo "âœ… X APIèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
        
        # PythonæŠ•ç¨¿ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        python3 - <<'EOF'
        import os
        import sys
        import json
        import time
        import random
        import hmac
        import hashlib
        import base64
        import urllib.parse
        import urllib.request
        import mimetypes
        
        # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—
        API_KEY = os.environ.get('X_API_KEY')
        API_SECRET = os.environ.get('X_API_SECRET')
        ACCESS_TOKEN = os.environ.get('X_ACCESS_TOKEN')
        ACCESS_TOKEN_SECRET = os.environ.get('X_ACCESS_TOKEN_SECRET')
        
        # æŠ•ç¨¿å†…å®¹
        TWEET_TEXT = "${{ inputs.tweet-text }}"
        IMAGE_FILE = "${{ inputs.image-file }}" if "${{ inputs.image-file }}" else None
        
        def create_oauth_signature(method, url, params, api_secret, token_secret):
            """OAuth 1.0a ç½²åã‚’ç”Ÿæˆ"""
            # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚½ãƒ¼ãƒˆ
            sorted_params = sorted(params.items())
            param_string = '&'.join([f"{k}={v}" for k, v in sorted_params])
            
            # ç½²åãƒ™ãƒ¼ã‚¹æ–‡å­—åˆ—
            signature_base = f"{method}&{urllib.parse.quote(url, safe='')}&{urllib.parse.quote(param_string, safe='')}"
            
            # ç½²åã‚­ãƒ¼
            signing_key = f"{api_secret}&{token_secret}"
            
            # HMAC-SHA1ç½²å
            signature = base64.b64encode(
                hmac.new(
                    signing_key.encode(),
                    signature_base.encode(),
                    hashlib.sha1
                ).digest()
            ).decode()
            
            return urllib.parse.quote(signature, safe='')
        
        def upload_media(file_path):
            """ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"""
            
            upload_url = "https://upload.twitter.com/1.1/media/upload.json"
            
            try:
                # OAuth 1.0aèªè¨¼
                oauth_params = {
                    'oauth_consumer_key': API_KEY,
                    'oauth_nonce': str(random.randint(0, 1000000000)),
                    'oauth_signature_method': 'HMAC-SHA1',
                    'oauth_timestamp': str(int(time.time())),
                    'oauth_token': ACCESS_TOKEN,
                    'oauth_version': '1.0'
                }
                
                # ç½²åç”Ÿæˆ
                oauth_params['oauth_signature'] = create_oauth_signature('POST', upload_url, oauth_params, API_SECRET, ACCESS_TOKEN_SECRET)
                
                # Authorization ãƒ˜ãƒƒãƒ€ãƒ¼
                auth_header = 'OAuth ' + ', '.join([f'{k}="{v}"' for k, v in sorted(oauth_params.items())])
                
                # ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
                with open(file_path, 'rb') as f:
                    file_data = f.read()
                
                # ãƒãƒ«ãƒãƒ‘ãƒ¼ãƒˆãƒœãƒ‡ã‚£ä½œæˆ
                boundary = f'----WebKitFormBoundary{random.randint(1000000000, 9999999999)}'
                
                body_parts = []
                body_parts.append(f'--{boundary}')
                body_parts.append('Content-Disposition: form-data; name="media"; filename="upload"')
                body_parts.append('Content-Type: application/octet-stream')
                body_parts.append('')
                
                body_prefix = '\r\n'.join(body_parts) + '\r\n'
                body_suffix = f'\r\n--{boundary}--\r\n'
                
                body = body_prefix.encode() + file_data + body_suffix.encode()
                
                # ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
                req = urllib.request.Request(upload_url, data=body, headers={
                    'Authorization': auth_header,
                    'Content-Type': f'multipart/form-data; boundary={boundary}'
                })
                
                with urllib.request.urlopen(req) as response:
                    result = json.loads(response.read().decode())
                    media_id = result.get('media_id_string')
                    if media_id:
                        print(f"âœ… ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ: {file_path} â†’ {media_id}")
                        return media_id
                    else:
                        print(f"âŒ ãƒ¡ãƒ‡ã‚£ã‚¢IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ: {file_path}")
                        return None
                        
            except urllib.error.HTTPError as e:
                error_body = e.read().decode()
                print(f"âŒ ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: {e.code} - {e.reason}")
                print(f"   ãƒ•ã‚¡ã‚¤ãƒ«: {file_path}")
                print(f"   è©³ç´°: {error_body}")
                return None
            except Exception as e:
                print(f"âŒ ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¾‹å¤–: {file_path} - {e}")
                return None
        
        def post_tweet(text, image_file):
            """ãƒ„ã‚¤ãƒ¼ãƒˆæŠ•ç¨¿"""
            
            url = "https://api.twitter.com/2/tweets"
            
            # ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            uploaded_media_ids = []
            if image_file and os.path.exists(image_file):
                print(f"ğŸ“¤ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­: {image_file}")
                media_id = upload_media(image_file)
                if media_id:
                    uploaded_media_ids.append(media_id)
                else:
                    print(f"âš ï¸ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã€ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã§æŠ•ç¨¿ã‚’ç¶šè¡Œ")
            
            # OAuth ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
            oauth_params = {
                'oauth_consumer_key': API_KEY,
                'oauth_nonce': str(random.randint(0, 1000000000)),
                'oauth_signature_method': 'HMAC-SHA1',
                'oauth_timestamp': str(int(time.time())),
                'oauth_token': ACCESS_TOKEN,
                'oauth_version': '1.0'
            }
            
            # ç½²åç”Ÿæˆ
            oauth_params['oauth_signature'] = create_oauth_signature('POST', url, oauth_params, API_SECRET, ACCESS_TOKEN_SECRET)
            
            # Authorizationãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆ
            auth_header = 'OAuth ' + ', '.join([f'{k}="{v}"' for k, v in sorted(oauth_params.items())])
            
            # ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£
            tweet_data = {'text': text}
            if uploaded_media_ids:
                tweet_data['media'] = {'media_ids': uploaded_media_ids}
                print(f"ğŸ“ ãƒ¡ãƒ‡ã‚£ã‚¢æ·»ä»˜: {len(uploaded_media_ids)}å€‹")
            
            body = json.dumps(tweet_data).encode('utf-8')
            
            # ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
            req = urllib.request.Request(url, data=body, headers={
                'Authorization': auth_header,
                'Content-Type': 'application/json'
            })
            
            try:
                with urllib.request.urlopen(req) as response:
                    result = json.loads(response.read().decode())
                    print(f"âœ… ãƒ„ã‚¤ãƒ¼ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ: {text}")
                    if uploaded_media_ids:
                        print(f"   ãƒ¡ãƒ‡ã‚£ã‚¢: {len(uploaded_media_ids)}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«")
                    print(f"   ãƒ„ã‚¤ãƒ¼ãƒˆID: {result['data']['id']}")
                    print(f"   URL: https://twitter.com/i/web/status/{result['data']['id']}")
                    return True
            except urllib.error.HTTPError as e:
                error_body = e.read().decode()
                print(f"âŒ ãƒ„ã‚¤ãƒ¼ãƒˆæŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: {e.code} - {e.reason}")
                print(f"   è©³ç´°: {error_body}")
                return False
        
        # ãƒ¡ã‚¤ãƒ³å‡¦ç†
        if not all([API_KEY, API_SECRET, ACCESS_TOKEN, ACCESS_TOKEN_SECRET]):
            print("âŒ èªè¨¼æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™")
            sys.exit(1)
        
        success = post_tweet(TWEET_TEXT, IMAGE_FILE)
        sys.exit(0 if success else 1)
        EOF
        
        echo ""
        echo "ğŸ‰ XæŠ•ç¨¿å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ"